---
title: "Tugas Praktikum MPDW 8: Model Seasonal ARIMA (SARIMA)"
author: "Deden Ahmad Rabani"
date: "3 November 2023"
output:
  rmdformats::readthedown:
    highlight: kate
---

# Packages

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(forecast)
library(TSA)
library(aTSA)
library(car)
library(lmtest)
library(nortest)
```

# Impor Data

Dataset yang digunakan merupakan data penjualan mobil dari seluruh dealer astra.

```{r data}
# import data dari excel

library(readxl)
df <- read_excel("C:/Users/Deden Ahmad Rabani/OneDrive - apps.ipb.ac.id/AstraWorld/daily_acquisition_2024.xlsx", sheet='Fix')
df
```

```{r data}
df$jumlah <- round(df$jumlah)

# mengubah data menjadi deret waktu harian dengan musiman mingguan (s=7)
df.ts <- ts(df$jumlah, start = c(1990, 1), frequency = 7)
```

# Eksplorasi Data

```{r}
library(ggplot2)
ggplot(df, aes(x = tanggal, y = jumlah)) +
  geom_line(color = "blue") +
  geom_point(color = "blue", size = 0.7) +
  labs(title = "Time Series Plot of jumlah", x = "Tanggal", y = "Jumlah") +
  theme_bw()
```

```{r}
dec.df <- decompose(df.ts)
plot(dec.df)
```

Secara eksplorasi, terlihat adanya kecenderungan data memiliki tren naik dan perilaku berulang kecenderungan (musiman) dalam deret tersebut. Kecenderungan musiman dapat dilihat dengan lebih jelas dengan menampilkan deret waktu per minggu.

```{r}
seasonplot(df.ts, 7, main="Seasonal Plot of jumlah (mingguan)", ylab="jumlah",
           year.labels = TRUE, col=rainbow(18))
```

Gambar menunjukkan adanya pola musiman mingguan (periode 7) pada data harian.

```{r}
monthplot(df.ts, ylab="Jumlah", col="blue")
```

```{r}
frame <- data.frame(
  values = as.numeric(df.ts),
  date = floor(time(df.ts))
)

library(ggplot2)
ggplot(frame, aes(y = values, x = date, group = date)) +
  geom_boxplot() +
  labs(x = "Tanggal", y = "Jumlah")
```

Berdasarkan hasil plot di atas dapat terlihat bahwa data memiliki pola yang berbeda dari tahun ke tahun sehingga untuk memastikan bahwa data homogen akan dilakukan uji homogenitas dengan `fligner.test`.

# Uji Homogenitas

Uji asumsi formal terhadap kehomogenan ragam yang digunakan yaitu *Fligner-Killen test*, dimana:

$H_0$ : Ragam homogen

$H_1$ : Ragam tidak homogen

```{r}
library(car)
fligner.test(values ~ date, data = frame)
```

Berdasarkan hasil uji *Fligner-Killeen* dengan menggunakan taraf signifikansi $\alpha=5\%$ didapatkan *p-value* sebesar 0.01989. $p-value= 0.01989 <\alpha=0.05$ sehingga tolak $H_0$  yang artinya **ragam data belum stasioner**. Sehingga diperlukan transformasi

# Transformasi Box-Cox

```{r}
# Transformasi Box-Cox
lambda <- BoxCox.lambda(df.ts)
df.ts.transformed <- BoxCox(df.ts, lambda)
```

# Uji Homogenitas Data Transformasi

```{r}
# Uji Homogenitas
frame.transform <- data.frame(
  values = as.numeric(df.ts.transformed),
  date = floor(time(df.ts.transformed))
)
fligner.test(values ~ date, data = frame.transform)
```

Berdasarkan hasil uji  *Fligner-Killeen* dengan data yang telah di transformasi, didapatkan *p-value* sebesar 0.9984. $p-value= 0.9984 >\alpha=0.05$ sehingga tolak $H_0$  yang artinya **ragam data sudah stasioner**.

# Pembagian Data

Pembagian data dilakukan dengan mengambil sekitar 80% data awal sebagai data latih dan 20% sisanya sebagai data uji.

```{r}
n <- length(df.ts.transformed)
train_end <- floor(0.8 * n)
trainh.ts <- window(df.ts.transformed, end = time(df.ts.transformed)[train_end])
testh.ts  <- window(df.ts.transformed, start = time(df.ts.transformed)[train_end + 1])
length(trainh.ts); length(testh.ts)
```

## Plot Data Latih

```{r}
autoplot(trainh.ts) + theme_bw() + xlab("Observasi") + ylab("jumlah")
```

## Plot Data Uji

```{r}
autoplot(testh.ts) + theme_bw() + xlab("Observasi") + ylab("jumlah")
```

# Non-Seasonal ARIMA

## Kestasioneran Data

```{r}
acf0.h <- acf(trainh.ts, main = "ACF", lag.max = 56, xaxt = "n", col = "blue")
axis(1, at = 0:56/7, labels = 0:56)
```


```{r}
acf0.h$lag <- acf0.h$lag * 7
acf0.1.h <- as.data.frame(cbind(acf0.h$acf, acf0.h$lag))
acf0.2.h <- acf0.1.h[which(acf0.1.h$V2 %% 7 == 0), ]
barplot(height = acf0.2.h$V1,
        names.arg = acf0.2.h$V2, ylab = "ACF", xlab = "Lag")
```

Berdasarkan plot deret sebelumnya diketahui bahwa perilaku deret berulang setiap minggu pada data harian, sehingga \(s = 7\). Plot ACF menurun secara perlahan yang menandakan belum stasioner

## Differencing

```{r}
d1.h <- diff(trainh.ts)
ts.plot(d1.h, type="l", xlab = "Observasi", ylab="d1 Xt", col="blue")
```

```{r}
acf1h <- acf(d1.h, lag.max = 56, xaxt = "n", main = "ACF", col = "blue")
axis(1, at = 0:56/7, labels = 0:56)
```

```{r}
acf1h$lag <- acf1h$lag * 7
acf1.1h <- as.data.frame(cbind(acf1h$acf, acf1h$lag))
acf1.2h <- acf1.1h[which(acf1.1h$V2 %% 7 == 0), ]
barplot(height = acf1.2h$V1, names.arg = acf1.2h$V2, ylab = "ACF", xlab = "Lag")
```

Berdasarkan plot ACF data *non-seasonal differencing* $d=1$ , kestasioneran komponen *non-seasonal* sudah teratasi namun masih ada lag seasonalnya yang belum stationer.

# Seasonal ARIMA

```{r}
D1.h <- diff(trainh.ts,7)
ts.plot(D1.h, type="l", xlab = "Observasi", ylab="D1 Xt", col="blue")
```

```{r}
acf2h<-acf(D1.h,lag.max=56,xaxt="n", main="ACF D1", col="blue")
```

```{r}
acf2h$lag <- acf2h$lag * 7
acf2.1h <- as.data.frame(cbind(acf2h$acf,acf2h$lag))
acf2.2h <- acf2.1h[which(acf2.1h$V2%%7==0),]
barplot(height = acf2.2h$V1, names.arg=acf2.2h$V2, ylab="ACF", xlab="Lag")
```

Pembedaan musiman \(D=1, s=7\) berhasil mengatasi ketidakstasioneran dalam rataan untuk komponen musiman (namun tidak untuk komponen non-musiman).

Untuk menghilangkan kecenderungan musiman dilakukan pembedaan musiman terhadap deret hasil pembedaan pertama.

```{r}
d1D1.h <- diff(D1.h)
ts.plot(d1D1.h, type="l", xlab = "Observasi", ylab="d1 D1 Xt", col="blue")
```

Setelah pembedaan pertama dan pembedaan musiman tampak bahwa deret sudah tidak memiliki kecenderungan apapun. Selanjutnya penentuan ordo *p*, *q* dan *P*, *Q* dapat dilakukan menggunakan plot ACF dan PACF contoh dari deret hasil pembedaan pertama dan pembedaan musiman tersebut.

# Identifikasi Model

## Plot ACF

```{r}
acf3h <- acf(d1D1.h,lag.max=56,xaxt="n", main="ACF d1D1", col="blue")
axis(1, at=0:56/7, labels=0:56)
```

```{r}
acf3h$lag <- acf3h$lag * 7
acf3.1h <- as.data.frame(cbind(acf3h$acf,acf3h$lag))
acf3.2h <- acf3.1h[which(acf3.1h$V2%%7==0),]
barplot(height = acf3.2h$V1, names.arg=acf3.2h$V2, ylab="ACF", 
xlab="Lag")
```

Berdasarkan plot ACF contoh lag 1 signifikan sehingga dipilih ordo *q*=1 , dan lag 12 adalah satu-satunya lag musiman yang signifikan sehingga order *Q*=1.

## Plot PACF

```{r}
pacf3h <- pacf(d1D1.h,lag.max=56,xaxt="n", main="PACF d1D1", col="blue")
axis(1, at=0:56/7, labels=0:56)
```

```{r}
pacf3h$lag <- pacf3h$lag * 7
pacf3.1h <- as.data.frame(cbind(pacf3h$acf,pacf3h$lag))
pacf3.2h <- pacf3.1h[which(pacf3.1h$V2%%7==0),]
barplot(height = pacf3.2h$V1, names.arg=pacf3.2h$V2, ylab="PACF", xlab="Lag")
```

Plot PACF contoh menunjukkan *cuts-off* pada lag-1 sehingga ordo *p*=1. dan pada pola musimannya juga terlihat model AR yang terbentuk karena cenderung *cuts-off* pada lag-1 sehingga ordo *P*=1

Model musiman kandidat yang dipilih untuk deret jumlah penjualan adalah $ARIMA(0,1,1)\times(1,1,1)_{7}$, $ARIMA(1,1,0)\times(1,1,1)_{7}$, $ARIMA(1,1,1)\times(1,1,1)_{7}$.

## Plot EACF

```{r}
TSA::eacf(d1D1.h)
```

Karena, kedua komponen telah stasioner. Identifikasi komponen *non-seasonal* adalah ARIMA(0,1,3), ARIMA(3,1,2). Identifikasi komponen *seasonal* adalah $ARIMA(1,1,1)_{12}$, sehingga model tentatif yang diperoleh adalah:

-   $ARIMA(0,1,1)\times(1,1,1)_{7}$

-   $ARIMA(1,1,0)\times(1,1,1)_{7}$

-   $ARIMA(1,1,1)\times(1,1,1)_{7}$

-   $ARIMA(0,1,3)\times(1,1,1)_{7}$

-   $ARIMA(3,1,2)\times(1,1,1)_{7}$

# Pendugaan Parameter

## ARIMA(0,1,1)x(1,1,1)7

```{r}
#ARIMA(0,1,1)x(1,1,1)7
tmodel1.df <- Arima(trainh.ts,order=c(0,1,1),seasonal=c(1,1,1))
summary(tmodel1.df)
lmtest::coeftest(tmodel1.df)
```

## ARIMA(1,1,0)x(1,1,1)7

```{r}
#ARIMA(1,1,0)x(1,1,1)7
tmodel2.df <- Arima(trainh.ts,order=c(1,1,0),seasonal=c(1,1,1))
summary(tmodel2.df)
lmtest::coeftest(tmodel2.df)
```

## ARIMA(1,1,1)x(1,1,1)7

```{r}
#ARIMA(1,1,1)x(1,1,1)7
tmodel3.df <- Arima(trainh.ts,order=c(1,1,1),seasonal=c(1,1,1))
summary(tmodel3.df)
lmtest::coeftest(tmodel3.df)
```

## ARIMA(0,1,3)x(1,1,1)7

```{r}
#ARIMA(0,1,3)x(1,1,1)7
tmodel4.df <- Arima(trainh.ts,order=c(0,1,3),seasonal=c(1,1,1))
summary(tmodel4.df)
lmtest::coeftest(tmodel4.df)
```

## ARIMA(3,1,2)x(1,1,1)7

```{r}
#ARIMA(3,1,2)x(1,1,1)7
tmodel5.df <- Arima(trainh.ts,order=c(3,1,2),seasonal=c(1,1,1))
summary(tmodel5.df)
lmtest::coeftest(tmodel5.df)
```

```{r}
AICKandidatModel <- c(tmodel1.df$aic, tmodel2.df$aic, tmodel3.df$aic,
                      tmodel4.df$aic, tmodel5.df$aic)
AICcKandidatModel <- c(tmodel1.df$aicc, tmodel2.df$aicc, tmodel3.df$aicc,
                       tmodel4.df$aicc, tmodel5.df$aicc)
BICKandidatModel <- c(tmodel1.df$bic, tmodel2.df$bic, tmodel3.df$bic,
                      tmodel4.df$bic, tmodel5.df$bic)
KandidatModelARIMA <- c("ARIMA(0,1,1)(1,1,1)7", "ARIMA(1,1,0)(1,1,1)7",
                        "ARIMA(1,1,1)(1,1,1)7", "ARIMA(0,1,3)(1,1,1)7",
                        "ARIMA(3,1,2)(1,1,1)7")
compmodelARIMA <- cbind(KandidatModelARIMA, AICKandidatModel,
                        AICcKandidatModel, BICKandidatModel)
colnames(compmodelARIMA) <- c("Kandidat Model", "Nilai AIC", 
                              "Nilai AICc", "Nilai BIC")
compmodelARIMA <- as.data.frame(compmodelARIMA)
compmodelARIMA
```

Model **terbaik** berdasarkan nilai **AIC dan AICc terkecil** dari kandidat model **yaitu** $ARIMA(0,1,1)\times(1,1,1)_{7}$

# Diagnostik Model

## Eksplorasi Sisaan

```{r}
tsdisplay(residuals(tmodel1.df), lag.max=56, 
          main='ARIMA(0,1,1)(1,1,1)7 Model Residuals', col="blue")
```

```{r}
#Eksplorasi
sisaan.model1 <- tmodel1.df$residuals
par(mfrow=c(2,2))
car::qqPlot(sisaan.model1)
plot(c(1:length(sisaan.model1)),sisaan.model1)
acf(sisaan.model1)
pacf(sisaan.model1)
par(mfrow = c(1,1))
```

Berdasarkan plot di atas terlihat bahwa sisaan mengikuti sebaran normal. Sisaan juga terlihat homogen berdasarkan plot. Selanjutnya, ditinjau dari plot ACF dan PACF terlihat bahwa ada lag yang signifikan. Hal tersebut menunjukkan bahwa kemungkinan ada gejala autokorelasi pada sisaan. Selanjutnya, untuk memastikan kembali akan dilakukan uji asumsi secara formal:

## Uji Formal

```{r}
#1) Sisaan Menyebar Normal
#tak tolak H0 > sisaan menyebar normal
shapiro.test(sisaan.model1)
nortest::ad.test(sisaan.model1)
```

Selain dengan eksplorasi, asumsi tersebut dapat diuji menggunakan uji formal. Pada tahapan ini uji formal yang digunakan untuk normalitas adalah uji Shapiro-Wilk, dan Anderson-Darling. Hipotesis pada uji kenormalan adalah sebagai berikut.

$H_0$ : Sisaan menyebar normal

$H_1$ : Sisaan tidak menyebar normal

Berdasarkan semua uji yang dilakukan, didapat *p-value* sebesar $0.1234$, $0.09398$ yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan data tersebut menyebar normal sesuai dengan eksplorasiyang dilakukan sebelumnya.

```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan.model1, type = "Ljung") 
#tak tolak H0 > sisaan saling bebas
```

Selanjutnya akan dilakukan uji formal untuk kebebasan sisaan menggunakan uji Ljung-Box. Hipotesis yang digunakan adalah sebagai berikut.

$H_0$ : Sisaan saling bebas

$H_1$ : Sisaan tidak tidak saling bebas

Berdasarkan uji Ljung-Box tersebut, didapat *p-value* sebesar 0.7798 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa sisaan saling bebas. Hal ini berbeda dengan eksplorasi.

```{r}
#3) Sisaan homogen 
Box.test((sisaan.model1)^2, type = "Ljung")  
#tak tolak H0 > sisaan homogen
```

Hipotesis yang digunakan untuk uji kehomogenan ragam adalah sebagai berikut.

$H_0$ : Ragam sisaan homogen

$H_1$ : Ragam sisaan tidak homogen

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat *p-value* sebesar 0.1367 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa ragam sisaan homogen. HAl ini sesuai dengan eksplorasi.

```{r}
#4) Nilai tengah sisaan sama dengan nol 
t.test(sisaan.model1, mu = 0, conf.level = 0.95) 
#tak tolak h0 > nilai tengah sisaan sama dengan 0
```

Terakhir, dengan uji-t, akan dicek apakah nilai tengah sisaan sama dengan nol. Hipotesis yang diujikan sebagai berikut.

$H_0$ : nilai tengah sisaan sama dengan 0

$H_1$ : nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-ttersebut, didapat *p-value* sebesar 0.9056 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa nilai tengah sisaan sama dengan nol.

# Overfitting

Pertama, *overfit* pada model non-musimannya (p,q)

## ARIMA(0,1,2)x(1,1,1)12

```{r}
#ARIMA(0,1,2)x(1,1,1)12
tmodel1.ofq <- Arima(trainh.ts,order=c(0,1,2),seasonal=c(1,1,1))
summary(tmodel1.ofq)
lmtest::coeftest(tmodel1.ofq)
```

## ARIMA(1,1,1)x(1,1,1)12

```{r}
#ARIMA(1,1,1)x(1,1,1)12
tmodel1.ofp <- Arima(trainh.ts,order=c(1,1,1),seasonal=c(1,1,1))
summary(tmodel1.ofp)
lmtest::coeftest(tmodel1.ofp)
```

Pada model musiman, ordo yang dilakukan *overfit* adalah ordo musiman (*P*, *Q*).

## ARIMA(0,1,1)x(2,1,1)12

```{r}
#ARIMA(0,1,1)x(2,1,1)12
tmodel1.ofP <- Arima(trainh.ts,order=c(0,1,1),seasonal=c(2,1,1))
summary(tmodel1.ofP)
lmtest::coeftest(tmodel1.ofP)
```

## ARIMA(0,1,1)x(1,1,2)12

```{r}
#ARIMA(0,1,1)x(1,1,2)12
tmodel1.ofQ <- Arima(trainh.ts,order=c(0,1,1),seasonal=c(1,1,2))
summary(tmodel1.ofQ)
lmtest::coeftest(tmodel1.ofQ)
```

Model *overfitting* yang dicobakan yaitu $ARIMA(0,1,1)\times(1,1,2)_{12}$ menghasilkan signifikansi parameter yang lebih baik dari model awal. Oleh karena itu, model $ARIMA(0,1,1)\times(1,1,2)_{12}$ dilakukan diagnostik model kembali.

# Diagnostik Model Overfitting

## Eksplorasi Sisaan

```{r}
tsdisplay(residuals(tmodel1.ofQ), lag.max=45, 
          main='ARIMA(0,1,1)(1,1,2)12 Model Residuals', col="blue")
```

```{r}
#Eksplorasi
sisaan.model1ofQ <- tmodel1.ofQ$residuals
par(mfrow=c(2,2))
car::qqPlot(sisaan.model1ofQ)
plot(c(1:length(sisaan.model1ofQ)),sisaan.model1ofQ)
acf(sisaan.model1ofQ)
pacf(sisaan.model1ofQ)
par(mfrow = c(1,1))
```

## Uji Formal

```{r}
#1) Sisaan Menyebar Normal
#tak tolak H0 > sisaan menyebar normal
shapiro.test(sisaan.model1ofQ)
nortest::ad.test(sisaan.model1ofQ)
```

Selain dengan eksplorasi, asumsi tersebut dapat diuji menggunakan uji formal. Pada tahapan ini uji formal yang digunakan untuk normalitas adalah uji Shapiro-Wilk, dan Anderson-Darling. Hipotesis pada uji kenormalan adalah sebagai berikut.

$H_0$ : Sisaan menyebar normal

$H_1$ : Sisaan tidak menyebar normal

Berdasarkan semua uji yang dilakukan, didapat *p-value* sebesar $0.076$, $0.05097$ yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan data tersebut menyebar normal sesuai dengan eksplorasiyang dilakukan sebelumnya.

```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan.model1ofQ, type = "Ljung") 
#tak tolak H0 > sisaan saling bebas
```

Selanjutnya akan dilakukan uji formal untuk kebebasan sisaan menggunakan uji Ljung-Box. Hipotesis yang digunakan adalah sebagai berikut.

$H_0$ : Sisaan saling bebas

$H_1$ : Sisaan tidak tidak saling bebas

Berdasarkan uji Ljung-Box tersebut, didapat *p-value* sebesar 0.7755 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa sisaan saling bebas. Hal ini berbeda dengan eksplorasi.

```{r}
#3) Sisaan homogen 
Box.test((sisaan.model1ofQ)^2, type = "Ljung")  
#tak tolak H0 > sisaan homogen
```

Hipotesis yang digunakan untuk uji kehomogenan ragam adalah sebagai berikut.

$H_0$ : Ragam sisaan homogen

$H_1$ : Ragam sisaan tidak homogen

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat *p-value* sebesar 0.2122 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa ragam sisaan homogen. HAl ini sesuai dengan eksplorasi.

```{r}
#4) Nilai tengah sisaan sama dengan nol 
t.test(sisaan.model1ofQ, mu = 0, conf.level = 0.95) 
#tak tolak h0 > nilai tengah sisaan sama dengan 0
```

Terakhir, dengan uji-t, akan dicek apakah nilai tengah sisaan sama dengan nol. Hipotesis yang diujikan sebagai berikut.

$H_0$ : nilai tengah sisaan sama dengan 0

$H_1$ : nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-ttersebut, didapat *p-value* sebesar 0.9076 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa nilai tengah sisaan sama dengan nol.

# Peramalan

```{r}
ramalan_h <- length(testh.ts)
ramalan_sarima.df <- forecast::forecast(tmodel1.ofQ, h = ramalan_h)
ramalan_sarima.df
```

```{r}
autoplot(ramalan_sarima.df, col="blue") + xlab("Tanggal") + ylab("Jumlah")
```

```{r}
accuracy(ramalan_sarima.df,testh.ts)
```

# Kesimpulan

Berdasarkan analisis yang dilakukan pada data karyawan df ini, ARIMA yang didapatkan adalah ARIMA(0,1,1) dengan seasonalnya (1,1,2) dan MAPE training sebesar 0.2035% sedangkan MAPE testing sebesar 0.163% sehingga dapat disimpulkan model ini sangat baik untuk dilakukan terhadap peramalan.
